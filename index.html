<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Minuteur S√©quentiel</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 0; background: #f9f9f9; }
  header { background: #333; color: white; padding: 10px; }
  .hidden { display: none; }
  button { margin: 5px; padding: 10px 15px; font-size: 14px; cursor: pointer; }
  input { padding: 5px; margin: 5px; }
  table { margin: auto; border-collapse: collapse; }
  td, th { border: 1px solid #ccc; padding: 5px; }
  svg { margin-top: 20px; }
  .color-picker { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }
  .color-option {
    width: 25px; height: 25px; border-radius: 50%; border: 2px solid #fff;
    cursor: pointer; box-shadow: 0 0 2px rgba(0,0,0,0.5);
  }
  .color-option.selected { border: 2px solid #000; }
  #sequencePreview {
    display: flex; justify-content: center; gap: 6px; margin: 15px 0; flex-wrap: wrap;
  }
  .preview-step {
    width: 30px; height: 30px; border-radius: 50%; display: flex;
    align-items: center; justify-content: center; color: white; font-size: 12px;
    font-weight: bold; box-shadow: 0 0 2px rgba(0,0,0,0.5);
    cursor: pointer;
  }
  /* Popup d'√©dition */
  #editPopup {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: white; padding: 15px; border: 1px solid #ccc;
    box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 999;
  }
  #editPopup h3 { margin-top: 0; }
</style>
</head>
<body>

<header>
  <h1>‚è± Minuteur S√©quentiel</h1>
</header>

<!-- Page Configuration -->
<div id="configPage">
  <h2>Cr√©er une s√©quence</h2>
  <div>
    <input type="number" id="stepDuration" placeholder="Dur√©e (s)" min="1">
    <input type="text" id="stepLabel" placeholder="Label (optionnel)">
    <div class="color-picker" id="colorPicker"></div>
    <button onclick="addStep()">Ajouter</button>
  </div>
  <div id="sequencePreview"></div>
  <table id="sequenceTable">
    <thead><tr><th>Couleur</th><th>Dur√©e (s)</th><th>Label</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
  <button onclick="startSequence()">‚ñ∂ Lancer la s√©quence</button>
</div>

<!-- Page Minuteur -->
<div id="timerPage" class="hidden">
  <h2 id="currentLabel"></h2>
  <svg width="200" height="200">
    <circle r="90" cx="100" cy="100" stroke="#ccc" stroke-width="10" fill="none"/>
    <circle id="progress" r="90" cx="100" cy="100" stroke="tomato" stroke-width="10"
      fill="none" stroke-dasharray="565" stroke-dashoffset="565"
      stroke-linecap="round" transform="rotate(-90 100 100)"/>
    <text id="timeText" x="100" y="110" text-anchor="middle" font-size="24">0</text>
  </svg>
  <div>
    <button onclick="pauseTimer()">‚è∏ Pause</button>
    <button onclick="resumeTimer()">‚ñ∂ Reprendre</button>
    <button onclick="stopSequence()">‚èπ Arr√™ter</button>
  </div>
</div>

<!-- Popup Edition -->
<div id="editPopup" class="hidden">
  <h3>Modifier l'√©tape</h3>
  <input type="number" id="editDuration" placeholder="Dur√©e (s)" min="1">
  <input type="text" id="editLabel" placeholder="Label">
  <div class="color-picker" id="editColorPicker"></div>
  <div>
    <button onclick="saveEdit()">üíæ Sauvegarder</button>
    <button onclick="closeEdit()">‚ùå Annuler</button>
  </div>
</div>

<script>
let sequence = JSON.parse(localStorage.getItem("sequence") || "[]");
let currentStepIndex = 0;
let timerInterval = null;
let pauseTime = null;
let selectedColor = "#ff6347";
let editIndex = null;
const circumference = 2 * Math.PI * 90;
document.getElementById("progress").style.strokeDasharray = circumference;

// Couleurs propos√©es
const colors = ["#ff6347", "#4caf50", "#2196f3", "#ff9800", "#9c27b0", "#00bcd4"];

// Init color picker principal
const colorPicker = document.getElementById("colorPicker");
colors.forEach(color => {
  const div = document.createElement("div");
  div.classList.add("color-option");
  div.style.backgroundColor = color;
  div.onclick = () => {
    selectedColor = color;
    document.querySelectorAll("#colorPicker .color-option").forEach(c => c.classList.remove("selected"));
    div.classList.add("selected");
  };
  if (color === selectedColor) div.classList.add("selected");
  colorPicker.appendChild(div);
});

// Init color picker pour √©dition
const editColorPicker = document.getElementById("editColorPicker");
colors.forEach(color => {
  const div = document.createElement("div");
  div.classList.add("color-option");
  div.style.backgroundColor = color;
  div.onclick = () => {
    selectedColor = color;
    document.querySelectorAll("#editColorPicker .color-option").forEach(c => c.classList.remove("selected"));
    div.classList.add("selected");
  };
  editColorPicker.appendChild(div);
});

function renderSequence() {
  const tbody = document.querySelector("#sequenceTable tbody");
  tbody.innerHTML = "";
  const preview = document.getElementById("sequencePreview");
  preview.innerHTML = "";
  
  sequence.forEach((step, i) => {
    // Tableau
    tbody.innerHTML += `<tr>
      <td><div style="width:20px;height:20px;background:${step.color};border-radius:50%;margin:auto"></div></td>
      <td>${step.duration}</td>
      <td>${step.label || ""}</td>
      <td><button onclick="removeStep(${i})">üóë</button></td>
    </tr>`;
    // Aper√ßu interactif
    const div = document.createElement("div");
    div.classList.add("preview-step");
    div.style.backgroundColor = step.color;
    div.textContent = step.duration;
    div.onclick = () => openEdit(i);
    preview.appendChild(div);
  });
}

function addStep() {
  const duration = parseInt(document.getElementById("stepDuration").value);
  const label = document.getElementById("stepLabel").value;
  if (!duration) return alert("Dur√©e invalide");
  sequence.push({ duration, label, color: selectedColor });
  localStorage.setItem("sequence", JSON.stringify(sequence));
  renderSequence();
}

function removeStep(i) {
  sequence.splice(i, 1);
  localStorage.setItem("sequence", JSON.stringify(sequence));
  renderSequence();
}

function openEdit(index) {
  editIndex = index;
  const step = sequence[index];
  document.getElementById("editDuration").value = step.duration;
  document.getElementById("editLabel").value = step.label || "";
  selectedColor = step.color;
  document.querySelectorAll("#editColorPicker .color-option").forEach(c => {
    c.classList.toggle("selected", c.style.backgroundColor === step.color);
  });
  document.getElementById("editPopup").classList.remove("hidden");
}

function saveEdit() {
  const duration = parseInt(document.getElementById("editDuration").value);
  const label = document.getElementById("editLabel").value;
  if (!duration) return alert("Dur√©e invalide");
  sequence[editIndex] = { duration, label, color: selectedColor };
  localStorage.setItem("sequence", JSON.stringify(sequence));
  renderSequence();
  closeEdit();
}

function closeEdit() {
  document.getElementById("editPopup").classList.add("hidden");
}

function startSequence() {
  if (sequence.length === 0) return alert("Aucune √©tape !");
  localStorage.setItem("sequence", JSON.stringify(sequence));
  currentStepIndex = 0;
  document.getElementById("configPage").classList.add("hidden");
  document.getElementById("timerPage").classList.remove("hidden");
  startStep();
}

function startStep() {
  if (currentStepIndex >= sequence.length) {
    alert("S√©quence termin√©e !");
    stopSequence();
    return;
  }
  const step = sequence[currentStepIndex];
  document.getElementById("currentLabel").textContent = step.label || `√âtape ${currentStepIndex+1}`;
  document.getElementById("progress").setAttribute("stroke", step.color);
  startTimer(step.duration, updateDisplay, () => {
    currentStepIndex++;
    startStep();
  });
}

function startTimer(duration, onUpdate, onComplete) {
  let start = Date.now();
  let end = start + duration * 1000;
  timerInterval = setInterval(() => {
    let now = Date.now();
    let remaining = Math.max(0, Math.round((end - now) / 1000));
    let progress = (duration - remaining) / duration;
    onUpdate(remaining, progress);
    if (remaining <= 0) {
      clearInterval(timerInterval);
      onComplete();
    }
  }, 100);
}

function updateDisplay(remaining, progress) {
  document.getElementById("timeText").textContent = remaining;
  document.getElementById("progress").style.strokeDashoffset = circumference * (1 - progress);
}

function pauseTimer() {
  clearInterval(timerInterval);
  pauseTime = parseInt(document.getElementById("timeText").textContent);
}

function resumeTimer() {
  if (pauseTime != null) {
    startTimer(pauseTime, updateDisplay, () => {
      currentStepIndex++;
      startStep();
    });
    pauseTime = null;
  }
}

function stopSequence() {
  clearInterval(timerInterval);
  document.getElementById("timerPage").classList.add("hidden");
  document.getElementById("configPage").classList.remove("hidden");
}

renderSequence();
</script>
</body>
</html>
